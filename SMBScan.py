import importlib
import subprocess
import ipaddress

# Check if the smbprotocol library is installed
try:
    importlib.import_module('smbprotocol')
except ImportError:
    # If the library isn't installed, install it using pip
    subprocess.check_call(['pip', 'install', 'smbprotocol'])

# Now that the library is installed, import it
from smbprotocol.connection import Connection, SMB_PROTOCOLS
from smbprotocol.exceptions import SMBException
from smbprotocol.session import Session

# Prompt the user for the IP range, username, and password
ip_range = input("Enter the IP range to scan (e.g. 192.168.1.1/24): ")
username = input("Enter your username: ")
password = input("Enter your password: ")

# Loop through each IP address in the range
for ip in ipaddress.IPv4Network(ip_range):
    try:
        # Create a new SMB connection and force SMBv1 if available
        conn = Connection(str(ip), negotiate_protocol=SMB_PROTOCOLS.SMB1)
        # Connect to the server using the specified username and password
        conn.connect(username=username, password=password)
        # Create a new SMB session
        session = Session(conn)
        # List all the shares on the server
        shares = session.list_shares()
        # Print the name of each share
        for share in shares:
            print('Share found on {}: {}'.format(ip, share.name))
    except SMBException as e:
        # If an error occurs, ignore it and move on to the next IP address
        pass
    finally:
        # Close the connection when you're done
        conn.close()
