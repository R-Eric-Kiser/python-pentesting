import socket
import pyodbc
import ipaddress

# set up the connection string template
connection_string = 'Driver=ODBC Driver 17 for SQL Server;Server=%s;Database=master;Trusted_Connection=yes;'

# define a function to check if a server is running SQL Server
def is_sql_server(server):
    try:
        socket.gethostbyname_ex(server)
        conn = pyodbc.connect(connection_string % server)
        cursor = conn.cursor()
        cursor.execute('SELECT name FROM sys.databases')
        databases = [database[0] for database in cursor.fetchall()]
        conn.close()
        return True, databases
    except:
        return False, []

# prompt user for server IP range
ip_range = input("Enter server IP range to scan (e.g. 192.168.0.1/24): ")
network = ipaddress.ip_network(ip_range, strict=False)

# search for SQL databases on the network
databases = {}
for ip in network.hosts():
    server = str(ip)
    print(f'Searching {server}...')
    is_running, database_list = is_sql_server(server)
    if is_running:
        print(f'{server} is running SQL Server with the following databases:')
        print(database_list)
        databases[server] = database_list
    else:
        print(f'{server} is not running SQL Server.')

# do something with the list of databases
print('Found the following databases:')
print(databases)
